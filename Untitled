<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>我的订单</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="/img/logo.ico" rel="icon" type="image/x-icon"/>
    <link rel="stylesheet" href="/css/wechat/alertMsg.css"/>
    <style>
        *{margin:0;padding:0;-webkit-tap-highlight-color:rgba(255,255,255,0);font-size:12px}a:active,a:hover,a:link,a:visited{color:#4a4a4a;text-decoration:none;outline:none}html,body{width:100%;background-color:#ebebeb}body{box-sizing:border-box}header{width:100%;background-color:#d71345;padding:0 60px;box-sizing:border-box;line-height:32px;height:32px;color:white;position:relative;text-align:center;font-size:14px;box-shadow:0 2px 4px rgba(0,0,0,0.2)}header .left,header .right{height:32px;line-height:32px;position:absolute;width:60px;top:0}header .right{padding-right:10px;right:0;background:url(/img/wechat/filter.png) no-repeat 45px 8px}.order_title{height:32px;line-height:32px;box-sizing:border-box;padding:0 10px;background-color:#f1f1f1;color:#bdbdbd;border-bottom:1px solid #d8d8d8}.order_title .left{float:left}.order_title .right{float:right}.order_footer{padding:0 10px 10px;background-color:white}.order_footer:after{clear:both;display:block;content:'';visibility:hidden}.order_footer .left{float:left;width:65%}.order_footer .left .green{color:#45b97c}.order_footer .right{float:right;width:35%;text-align:right;color:#d71345}.order_content{padding:10px;background-color:white}.order_content .order_status{color:#d71345;margin-bottom:10px}.order_content .order_status.green{color:#45b97c}.order_content .order_middle:after{clear:both;display:block;visibility:hidden;content:''}.order_content .product_name{float:left;width:90%}.order_content .product_name div{font-size:18px;color:#737373}.order_content .product_name .detail{color:#bdbdbd;font-size:12px;margin-top:10px}.order_content .destination,.order_content .distance,.order_content .more{float:left}.order_content .destination{width:30%}.order_content .destination .name{color:#737373;font-size:18px}.order_content .destination .type,.order_content .destination .time{color:#737373;font-size:12px}.order_content .destination .type{margin-top:10px;margin-bottom:5px}.order_content .destination .time{color:#bdbdbd}.order_content .distance{width:30%;color:#d8d8d8}.order_content .distance .green{color:#45b97c;margin:8px 0 0}.order_content .distance div{margin-top:4px}.order_content .more{width:10%;background:url(/img/wechat/rightArrow.png) no-repeat;height:20px;margin-top:15px;text-indent:-9999px}.order_content .cutline{height:10px;margin-top:20px;background:url(/img/wechat/pot.png) repeat}.order{margin-bottom:20px}.order a{height:40px;line-height:40px;background-color:#45b97c;color:white;font-size:14px;display:inline-block;width:100%;text-align:center}.product{background-color:white;padding:0 10px}.product .product_item{background:url(/img/wechat/hotel.png) no-repeat 0 center;text-indent:20px;height:30px;line-height:30px;border-top:1px solid #d8d88d;box-sizing:border-box;color:#bdbdbd}.filter-order{width:100%;position:fixed;bottom:-300px;background-color:#fff}.filter-order .finished-filter,.filter-order .modifying-filter,.filter-order .closed-filter,.filter-order .waiting-filter,.filter-order .pending-filter,.filter-order .close,.filter-order .cancelled-filter,.filter-order .refund-filter,.filter-order .all-order{width:100%;margin:0 auto;text-align:center;font-size:12px;color:#454545;height:45px;border-top:1px solid #cdd0d7}.filter-order .close{border-top:14px solid #cdd0d7}.filter-order span{line-height:45px}.filter-order{bottom:-300px}.filter-order.show{bottom:0;transition:bottom 300ms ease-out 0ms}
    </style>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?a65d35584b7b068b033f3b2578d39b30";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
<header>
    我的订单
    <span class="right">筛选</span>
</header>

<#list orders as order>
    <#if order.status=="waiting for payment">
    <div class="order waiting">
    <#else>
    <div class="order ${order.status}">
    </#if>
    <div class="order_title">
        <div class="left">订单编号：${order.id}</div>
        <div class="right">${order.bookingTime}</div>
    </div>
    <form class="form_status" action="/wechat/front/order/detail" method="post">
        <div class="order_content">
            <div class="order_status">
                <#if order.status=="waiting for payment">
                    待支付（请在<span class="minite">${order.reserveTimeMin}</span>分<span class="second">${order.reserveTimeSec}</span>秒内完成支付）
                </#if>
                <#if order.status=="closed">
                    已关闭<#if !order.hasProducts>，请在<#if !order.isTourism>自由购</#if><#if order.isTourism>订购</#if>栏目重新购买！</#if>
                </#if>
                <#if order.status=="refund">
                    <!--Order being refunded-->
                    已退款
                </#if>
                <#if order.status=="modifying">
                    <!--Order being modified by customer server-->
                    修改中
                </#if>
                <#if order.status=="finished">
                    <!--Order finished-->
                    已完成
                </#if>
            </div>
            <div class="order_middle">
                <#if order.isTourism>
                    <div class="destination">
                        <div class="name">${order.departure}</div>
                        <div class="type">出发地</div>
                        <div class="time">${order.departTime}</div>
                    </div>
                    <div class="distance">
                        <div class="green">
                        ${order.isShuttle?string('往&nbsp;&nbsp;&nbsp;&nbsp;返','单&nbsp;&nbsp;&nbsp;&nbsp;程')}
                        </div>
                        <div class="green">
                        ${order.distance}&nbsp;km
                        </div>
                        <div>
                        ${order.days}&nbsp;day
                        </div>
                    </div>
                    <div class="destination">
                        <div class="name">${order.arrival}</div>
                        <div class="type">目的地</div>
                        <div class="time">${order.arriveTime}</div>
                    </div>
                <#else>
                    <div class="product_name">
                        <div>${order.productName}</div>
                        <div class="detail">${order.body}</div>
                    </div>
                </#if>
                <div class="more">
                    <!--Detail entrance-->
                </div>
                <input type="text" style="display: none;" name="orderId" value="${order.id}"/>
            </div>
            <div class="cutline"></div>
        </div>
    </form>
    <div class="order_footer">
        <div class="left">
            您已选择在<span class="green">${order.startOffYear}年${order.startOffMonth}月${order.startOffDay}日</span>出行
        </div>
        <div class="right">
            <#if order.isFromSimpleTour>
                合计：<#if order.gatewayCode!="stpass">${order.totalPrice}元</#if>
                <#if order.gatewayCode=="stpass">简途通${order.amount}天</#if>
            </#if>
        </div>
    </div>
    <#if order.hasProducts>
        <div class="product">
            <div class="product_item">
                含${order.includeProductSummary}
            </div>
        </div>
    </#if>

    <form class="pay_form" action="/wechat/front/order/pay/paydetail" method="post">
        <#if order.status=="waiting for payment">
            <#if order.gatewayCode=="wechat">
                <a class="pay" href="javascript:void(0);">
                    立即支付
                </a>
            </#if>
            <#if order.gatewayCode=="stpass" && order.tourismId!=0>
                <a class="exchange" href="#" orderid="${order.id}" gateway="${order.gatewayCode}">
                    立即兑换
                </a>
            </#if>
        </#if>
        <#if order.status=="closed" && !order.hasProducts && order.isTourism && order.tourismId!=0>
            <#if order.gatewayCode=="wechat">
                <a class="rebuy" href="/wechat/front/product/tourism/tourism/${order.tourismId}"/>
                重新选购
                </a>
            </#if>
            <#if order.gatewayCode=="stpass">
                <a class="reexchange" href="/wechat/front/card/product/tourism/tourism/${order.tourismId}"/>
                重新选购
                </a>
            </#if>
        </#if>
        <input type="hidden" name="orderId" value="${order.id}"/>
        <input type="hidden" name="code" value="${code}">
        <input type="hidden" name="payFailUrl" value=""/>
        <#if order.sub>
            <input type="hidden" name="returnUrl" value="/wechat/front/order/pay/freebuysuccess/${order.id}"/>
        <#else>
            <input type="hidden" name="returnUrl" value="/wechat/front/order/pay/paysuccess/${order.id}"/>
        </#if>
    </form>
</div>
</#list>
    <div class="filter-order">
        <div class="filter-order-container">
            <div class="waiting-filter">
                <span>待支付</span>
            </div>
            <div class="finished-filter">
                <span>已完成</span>
            </div>
            <div class="closed-filter">
                <span>已关闭</span>
            </div>
            <div class="all-order">
                <span>全部订单</span>
            </div>
            <div class="close">
                <span>取消</span>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/js/wechat/zepto.min.js"></script>
    <script type="text/javascript" src="/js/wechat/alert.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var interval = setInterval(function () {
                var flag = true;
                $('.order_status:not(.green)').each(function (index, el) {
                    var m = $(this).find('.minite').html();
                    var s = $(this).find('.second').html();
                    if (m != 0 || s != 0) {
                        flag = false;
                        if (s == 0) {
                            m = m - 1;
                            s = 59;
                        } else {
                            s = s - 1;
                        }
                        $(this).find('.minite').html(m);
                        $(this).find('.second').html(s);
                    } else if (m == 0 && s == 0) {
                        $(this).html('订单已关闭');
                        $(this).parents('.form_status').siblings('.pay_form').find('a.pay').attr('disabled', true).css('background-color', '#bdbdbd');
                    }
                });
                if (flag) {
                    clearInterval(interval);
                }
            }, 1000);
            $('.order_content').click(function () {
                $(this).parents('form').submit();
            });

            $('.pay').click(function () {
                if (!$(this).attr('disabled')) {
                    $(this).parents('form').submit();
                }
            });
            $('.exchange').click(function(e) {
                e.preventDefault();
                var orderId = $(this).attr('orderid');
                var gatewayCode = $(this).attr('gateway');
                var postData = {
                    orderId: orderId,
                    code: gatewayCode,
                    params: {
                        isWechatOrder: true
                    }
                };
                var json = JSON.stringify(postData);
                if(!$('.exchange').hasClass('disabled')) {
                    $('.exchange').addClass('disabled');
                    $.ajax({
                        type:'POST',
                        data: json,
                        contentType: 'application/json',
                        url: '/gateway/ordering',
                        success: function(res) {
                            var json = JSON.parse(res);
                            location.href = json.url;
                        },
                        error: function(res) {
                            $('.exchange').removeClass('disabled');
                            $.alertMsg.alert.show({
                                content: '网络异常！',
                                okContent: '我知道了!',
                                ok: function () {
                                    $.alertMsg.alert.hide();
                                }
                            });
                        }
                    });
                }
            });
            (function ($) {
                $('header .right').click(function () {	//显示订单filter功能按钮
                    $('.filter-order').toggleClass('show');
                });
                $('.waiting-filter').click(function () {  //筛选待支付的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.waiting').show();
                });
                $('.pending-filter').click(function () { //筛选已支付的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.pending').show();
                });
                $('.cancelled-filter').click(function () { //筛选已取消的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.cancelled').show();
                });
                $('.closed-filter').click(function () { //筛选已过期的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.closed').show();
                });
                $('.refund-filter').click(function () { //筛选已退款的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.refund').show();
                });
                $('.modifying-filter').click(function () { //筛选修改中的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.modifying').show();
                });
                $('.finished-filter').click(function () { //筛选已完成的订单
                    hide_filter();
                    $('.order').hide();
                    $('.order.finished').show();
                });
                $('.all-order').click(function () { // 显示全部订单
                    hide_filter();
                    $('.order').show();
                });
                $('.close').click(function () { // 取消上拉框
                    hide_filter();
                });

                function hide_filter() {
                    $('.filter-order').removeClass('show');
                }

                // 隐藏上拉框
                $(document).click(function (e) {
                    if (!($(e.target).hasClass('right') && $(e.target).parents('header'))) {
                        hide_filter();
                    }
                });
            })(Zepto);

        })
    </script>
</body>
</html>	
